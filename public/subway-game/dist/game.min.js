(()=>{var e=document.getElementById("gameCanvas"),t=e.getContext("2d"),o={boardDx:2,boardDy:16,boardScale:1.02,snapTol:28,pieces:{memory_poster_1:{tx:655,ty:102,scale:.99},memory_poster_2:{tx:829,ty:100,scale:1},memory_poster_3:{tx:807,ty:238,scale:1},memory_poster_4:{tx:653,ty:173,scale:1},memory_poster_5:{tx:653,ty:281,scale:1},memory_poster_6:{tx:742,ty:378,scale:1}}};function r(){if(!p.posterAssembleConfig){p.posterAssembleConfig=Object.assign({},o),p.posterAssembleConfig.pieces=JSON.parse(JSON.stringify(o.pieces));for(let e of Object.keys(o.pieces))p.posterAssembleConfig.pieces[e]||(p.posterAssembleConfig.pieces[e]={tx:null,ty:null,scale:1}),null==p.posterAssembleConfig.pieces[e].scale&&(p.posterAssembleConfig.pieces[e].scale=1)}return p.posterAssembleConfig}var i=1950,l=.44,n=.105,a=.074,s=.166,c=519,d=-73,u="assets/rooms/tickethall-active.png";e.width=1600,e.height=600;var p={canvas:e,ctx:t,keys:{},background:null,backgroundLoaded:!1,backgroundWidth:3200,backgroundScale:1,cameraX:0,gravity:.5,cameraX:0,gravity:.35,platformY:480,objects:[{id:1,type:"newspaper",name:"Newspaper",x:600,y:0,width:40,height:30,hover:!1},{id:2,type:"wallet",name:"Wallet",x:950,y:0,width:20,height:20,hover:!1}],inventory:[],overlayOpen:!1,viewedItem:null,introActive:!0,cameraX:0,gravity:.25,platformY:230,objects:[],objectSprites:{},paused:!1,settingsOpen:!1,settingsPage:"audio",keys:{ArrowUp:!1,ArrowDown:!1,ArrowLeft:!1,ArrowRight:!1,KeyW:!1,KeyA:!1,KeyS:!1,KeyD:!1,ShiftLeft:!1,ShiftRight:!1,Space:!1,KeyE:!1,KeyI:!1,KeyO:!1,KeyP:!1,Digit1:!1,Digit2:!1,Digit3:!1,Digit4:!1,Digit5:!1},inventory:[],activeSlot:0,phoneState:"DEAD",activeRing:null,phoneTimer:0,isPhoneLocked:!1,phoneAnimSprite:null,isPosterLocked:!1,posterAnimSprite:null,cutsceneLocked:!1,cutsceneAnimSprite:null,forceForwardFrames:0,tvOverlayEl:null,tvOverlayKey:null,controlPanelOpen:!1,controlPanel:{openedCount:0,selectedIndex:0,yellowOn:!1,blueOn:!1,greenOn:!1,systemStarted:!1},flags:{controlRoomUnlocked:!1,stationPowerOn:!1,tvMode:"static"},transition:{active:!1,alpha:0,state:"IDLE",timer:0,targetRoom:null,spawnX:0},pendingRoomSwitch:null,controlsLocked:!1,outsideState:{busStopInRange:!1,busStopVisitCount:0,posterGameComplete:!1,dadCutsceneStarted:!1},credits:{loaded:!1,error:null,data:null,active:!1,state:"OFF",lines:[],scrollY:0,speed:.75,totalHeight:0},posterAssembleOpen:!1,posterAssemble:{pieces:[],draggingId:null,dragOffsetX:0,dragOffsetY:0,completed:!1,pendingCutscene:!1},cameraOverrideX:null,scriptedTargetVx:0,dadNpc:{visible:!1,x:4700,y:0},currentRoom:"platform",rooms:{platform:{bg:"assets/rooms/station-platform.png",music:"platform",objects:[{type:"newspaper",x:800,y:280,width:50,height:35,name:"Newspaper",hovered:!1},{type:"wallet",x:2e3,y:280,width:40,height:30,name:"Wallet",hovered:!1}],exits:[{x:1300,w:150,target:"hallway",spawnX:250,label:"HALLWAY",dir:"up",type:"door"}]},hallway:{bg:"assets/rooms/station-hallway.png",music:"hallway",objects:[{type:"phone",x:1950,y:50,width:100,height:118,name:"Phone",hover:!1},{type:"poster",x:500,y:20,width:150,height:200,name:"Poster",hover:!1}],exits:[{target:"platform",x:50,w:100,h:200,type:"zone",dir:"left",spawnX:1300},{target:"ticket_hall",x:5850,w:100,h:200,type:"door",dir:"right",spawnX:300,label:"To Ticket Hall"}]},ticket_hall:{bg:"assets/rooms/station-tickethall.png",music:"tickethall",platformY:260,objects:[{type:"ticket_gates",x:800,y:200,width:150,height:200,name:"Ticket Gates",hover:!1,visible:!1},{type:"control_room_door",x:513,y:160,width:80,height:150,name:"Control Room",hover:!0,visible:!0}],exits:[{target:"hallway",x:50,w:100,h:200,type:"zone",dir:"left",spawnX:5700}]},control_room:{bg:"assets/rooms/station-control.png",music:"control",platformY:360,objects:[{type:"control_desk",x:1250,y:250,width:220,height:160,name:"Control Desk",hover:!1,visible:!1}],exits:[{target:"ticket_hall",x:50,w:100,h:200,type:"door",dir:"up",spawnX:520,label:"Ticket Hall"}]},outside:{bg:"assets/rooms/outside.png",music:"outside",platformY:260,objects:[{type:"bus_stop",x:1670,y:120,width:220,height:220,name:"Bus Stop",hover:!1,visible:!0}],exits:[{target:"ticket_hall",x:60,w:160,h:220,type:"door",dir:"down",spawnX:900,label:"Station",indicatorOffsetX:-50}]}},background:null,backgroundLoaded:!1,backgroundScale:1,backgroundWidth:0,logo:null,introActive:!0,introPhase:"wait",introTimer:0,introTextPlayed:!1,monologue:{active:!1,text:"",timer:0,alpha:0,queue:[],lastIdleLineIndex:-1,idleTimer:0,nextIdleThreshold:300,hasHitWall:!1,history:[],roomHistory:{}},health:{maxTime:108e3,current:108e3,percentage:100,state:"ALIVE",deathTimer:0,fadeAlpha:0}};function h(e){var t,o,r;return"ticket_hall"===e&&null!=(t=p.flags)&&t.stationPowerOn?u:null==(r=null==(o=p.rooms)?void 0:o[e])?void 0:r.bg}function f(){var e,t;null!=(e=p.flags)&&e.stationPowerOn&&null!=(t=p.rooms)&&t.ticket_hall&&p.rooms.ticket_hall.bg!==u&&(p.rooms.ticket_hall.bg=u)}var m={x:300,y:230,width:38,height:70,speed:5,runSpeed:8,jumpPower:-7,velocityX:0,velocityY:0,isGrounded:!1,facingRight:!0,direction:"right",animationFrame:0,sprites:{},spritesLoaded:0,isInteracting:!1,interactionTimer:0};p.background=new Image,p.background.onload=function(){p.backgroundLoaded=!0;let t=e.height/p.background.height;p.backgroundScale=t},p.background.src=h(p.currentRoom),p.objects=[...p.rooms[p.currentRoom].objects],m.animationTimer=0,m.animationSpeed=10,m.sprites={forward:null,walkRight1:null,walkRight2:null,runRight1:null,runRight2:null,runRight3:null,jump:null,pickup:null},p.background=new Image,p.background.onload=function(){p.backgroundLoaded=!0;let t=e.height/p.background.height;p.backgroundScale=t,p.backgroundWidth=p.background.width*t},p.background.src="assets/rooms/station-platform.png",m.sprites.forward=new Image,m.sprites.forward.onload=function(){m.spritesLoaded++},m.sprites.forward.src="assets/character-forward.png",m.sprites.walkRight1=new Image,m.sprites.walkRight1.onload=function(){m.spritesLoaded++},m.sprites.walkRight1.src="assets/character-right.png",m.sprites.walkRight2=new Image,m.sprites.walkRight2.onload=function(){m.spritesLoaded++},m.sprites.walkRight2.src="assets/character-right-still.png",m.sprites.runRight1=new Image,m.sprites.runRight1.onload=function(){m.spritesLoaded++},m.sprites.runRight1.src="assets/character-run-1.png",m.sprites.runRight2=new Image,m.sprites.runRight2.onload=function(){m.spritesLoaded++},m.sprites.runRight2.src="assets/character-run-2.png",m.sprites.runRight3=new Image,m.sprites.runRight3.onload=function(){m.spritesLoaded++},m.sprites.runRight3.src="assets/character-run-3.png",m.sprites.jump=new Image,m.sprites.jump.onload=function(){m.spritesLoaded++},m.sprites.jump.src="assets/character-jump.png",m.sprites.pickup=new Image,m.sprites.pickup.onload=function(){m.spritesLoaded++},m.sprites.pickup.src="assets/character-pickup.png",m.sprites.sleep=new Image,m.sprites.sleep.onload=function(){m.spritesLoaded++},m.sprites.sleep.src="assets/character-sleep.png",m.sprites.kneel1=new Image,m.sprites.kneel1.onload=function(){m.spritesLoaded++},m.sprites.kneel1.src="assets/character-kneel-1.png",m.sprites.back=new Image,m.sprites.back.src="assets/character-back.png",m.sprites.reach=new Image,m.sprites.reach.src="assets/character-reach.png",m.sprites.phoneTalk=new Image,m.sprites.phoneTalk.src="assets/character-phone.png",m.sprites.kneel2=new Image,m.sprites.kneel2.onload=function(){m.spritesLoaded++},m.sprites.kneel2.src="assets/character-kneel-2.png",m.sprites.death1=new Image,m.sprites.death1.onload=function(){m.spritesLoaded++},m.sprites.death1.src="assets/character-death-1.png",m.sprites.death2=new Image,m.sprites.death2.onload=function(){m.spritesLoaded++},m.sprites.death2.src="assets/character-death-2.png",m.sprites.death3=new Image,m.sprites.death3.onload=function(){m.spritesLoaded++},m.sprites.death3.src="assets/character-death-3.png",p.logo=new Image,p.logo.src="assets/terminal-logo.png";var g={phone:"assets/objects/phone.png",newspaper:"assets/objects/newspaper.png",wallet:"assets/objects/wallet.png",travel_card:"assets/objects/travel-card.png",keycard:"assets/objects/keycard.png",poster:"assets/objects/key-poster.png",bus_stop:"assets/objects/bus-stop.png",memory_poster_1:"assets/objects/memory-poster-1.png",memory_poster_2:"assets/objects/memory-poster-2.png",memory_poster_3:"assets/objects/memory-poster-3.png",memory_poster_4:"assets/objects/memory-poster-4.png",memory_poster_5:"assets/objects/memory-poster-5.png",memory_poster_6:"assets/objects/memory-poster-6.png",memory_poster_completed:"assets/objects/memory-poster-completed.png",character_dad:"assets/character-dad.png",control_panel_bg:"assets/control-panel.png",tv_static:"assets/tv-static.gif",tv_hospital:"assets/tv-hospital.gif",button_yellow:"assets/objects/button-yellow.png",button_yellow_glow:"assets/objects/button-yellow-glow.png",button_blue:"assets/objects/button-blue.png",button_blue_glow:"assets/objects/button-blue-glow.png",button_green:"assets/objects/button-green.png",button_green_glow:"assets/objects/button-green-glow.png",sys_start:"assets/objects/sys-start.png",sys_start_glow:"assets/objects/sys-start-glow.png",newspaper_large:"assets/objects/newspaper-large.png",wallet_large:"assets/objects/wallet-large.png",travel_card_large:"assets/objects/travel-card-large.png",keycard_large:"assets/objects/keycard-large.png",control_door:"assets/objects/control-door.png",control_room_door:"assets/objects/control-door.png",hallway:"assets/rooms/station-hallway.png",tickethall_active_bg:u};p.objectSprites={};for(let e in g){let t=new Image;t.src=g[e],p.objectSprites[e]=t}function y(e){p.music[e]&&p.music[e].play().catch(()=>{})}function v(e){p.music[e]&&(p.music[e].pause(),p.music[e].currentTime=0)}function b(e){p.sfx[e]&&(p.sfx[e].currentTime=0,p.sfx[e].volume=.6,p.sfx[e].play().catch(()=>{}))}function w(e,o,r){let i=String(e||"").split(/\s+/).filter(Boolean);if(0===i.length)return[""];t.save(),t.font=r;let l=[],n=i[0];for(let e=1;e<i.length;e++){let r=n+" "+i[e];t.measureText(r).width<=o?n=r:(l.push(n),n=i[e])}return l.push(n),t.restore(),l}function S(){if(p.credits.active)return;p.settingsOpen=!1,p.paused=!1,p.controlsLocked=!0,p.keys={};try{Object.keys(p.music||{}).forEach(e=>v(e))}catch(e){}y("endCredits"),p.credits.active=!0,p.credits.state="ROLL",p.credits.lines=function(e){let t=e||{},o="string"==typeof t.title?t.title:"TERMINAL",r="string"==typeof t.subtitle?t.subtitle:"",i=Array.isArray(t.sections)?t.sections:[],l=[];l.push({type:"title",text:o}),r&&l.push({type:"subtitle",text:r}),l.push({type:"spacer",h:24});for(let e of i){let t=e&&"string"==typeof e.header?e.header:"",o=e&&Array.isArray(e.entries)?e.entries:[];t&&(l.push({type:"header",text:t}),l.push({type:"spacer",h:10}));for(let e of o){let t=e&&"string"==typeof e.name?e.name:"",o=e&&"string"==typeof e.role?e.role:"";!t&&!o||(t&&l.push({type:"name",text:t}),o&&l.push({type:"role",text:o}),l.push({type:"spacer",h:10}))}l.push({type:"spacer",h:18})}return l.push({type:"spacer",h:40}),l}(p.credits.data),p.credits.scrollY=e.height+60;let t=Math.max(200,e.width-220);p.credits.totalHeight=function(e,t){let o=0;for(let r of e){if("spacer"===r.type){o+=r.h||0;continue}let e=12,i=18;"title"===r.type?(e=42,i=54):"subtitle"===r.type?(e=16,i=26):"header"===r.type?(e=18,i=30):"name"===r.type?(e=14,i=24):"role"===r.type&&(e=11,i=18);let l=`${e}px "Press Start 2P"`;o+=w(r.text,t,l).length*i}return o}(p.credits.lines,t)}function x(e){if(!p.monologue.ready||!p.monologue.data)return;let t=p.monologue.data.beats.filter(t=>t.event===e);0!==t.length&&t.forEach(t=>{if(!t.once||!p.monologue.history.includes(t.id)){if(p.monologue.history.push(t.id),t.delayMs&&t.delayMs>0){let o=Math.ceil(t.delayMs/16.6);p.monologue.queue.push({text:"",duration:o,meta:t.meta,beatId:t.id,eventKey:e})}t.lines.forEach((o,r)=>{let i=t.meta&&null!=t.meta.perChar?t.meta.perChar:5,l=t.meta&&null!=t.meta.minDuration?t.meta.minDuration:120,n=t.meta&&null!=t.meta.durationMult?t.meta.durationMult:1;p.monologue.queue.push({text:o,duration:Math.ceil(Math.max(l,o.length*i)*n),meta:t.meta,beatId:t.id,eventKey:e})})}})}function A(){p.posterAssembleOpen=!1,p.posterAssemble.draggingId=null,p.controlsLocked=!1,p.scriptedTargetVx=0}function T(){if("outside"!==p.currentRoom)return;let t=p.objects.find(e=>"bus_stop"===e.type);if(t){let e=m.x+m.width/2,o=t.x+t.width/2,r=Math.abs(e-o)<220;r&&!p.outsideState.busStopInRange&&(p.outsideState.busStopInRange=!0,p.outsideState.busStopVisitCount=(p.outsideState.busStopVisitCount||0)+1,1===p.outsideState.busStopVisitCount&&x("INTERACTION_BUS_STOP"),2===p.outsideState.busStopVisitCount&&x("INTERACTION_BUS_STOP_AGAIN")),r||(p.outsideState.busStopInRange=!1)}p.posterAssembleOpen&&p.posterAssemble.pendingCutscene&&!p.monologue.activeLine&&0===p.monologue.queue.length&&(p.posterAssemble.pendingCutscene=!1,A(),p.outsideState.posterGameComplete=!0),p.outsideState.posterGameComplete&&!p.outsideState.dadCutsceneStarted&&(p.outsideState.dadCutsceneStarted=!0,function(){p.controlsLocked=!0;let e=3e3,t=p.backgroundWidth||6e3,o=Math.max(200,Math.min(t-200,e));p.dadNpc.x=o,p.dadNpc.visible=!0;let r=Math.max(0,t-(m.width||40)-10),i=Math.max(0,Math.min(o-140,r));p.dadCutscene={active:!0,phase:"pan",dadX:o,meetX:i,triggeredDialogue:!1,fadeAlpha:0,fading:!1},function(e){if(!p.monologue.ready||!p.monologue.data)return;let t=p.monologue.data.beats.find(t=>t.id===e);if(t&&(!t.once||!p.monologue.history.includes(t.id))){if(p.monologue.history.push(t.id),t.delayMs&&t.delayMs>0){let e=Math.ceil(t.delayMs/16.6);p.monologue.queue.push({text:"",duration:e,meta:t.meta,beatId:t.id,eventKey:t.event})}t.lines.forEach(e=>{let o=t.meta&&null!=t.meta.perChar?t.meta.perChar:5,r=t.meta&&null!=t.meta.minDuration?t.meta.minDuration:120,i=t.meta&&null!=t.meta.durationMult?t.meta.durationMult:1;p.monologue.queue.push({text:e,duration:Math.ceil(Math.max(r,e.length*o)*i),meta:t.meta,beatId:t.id,eventKey:t.event})})}}("l5_dad_01")}()),p.dadCutscene&&p.dadCutscene.active&&function(){let t=p.dadCutscene;if(!t||!t.active)return;let o=Math.max(0,p.backgroundWidth-e.width),r=Math.max(0,Math.min(o,Math.floor(t.dadX-e.width/2)));if("pan"===t.phase)return p.cameraOverrideX=r,p.scriptedTargetVx=0,void(Math.abs(p.cameraX-r)<6&&(t.phase="walk"));if("walk"===t.phase){p.cameraOverrideX=r,m.direction="right",m.facingRight=!0;let e=p.backgroundWidth||6e3,o=Math.max(0,e-(m.width||40)-10);return void(m.x<t.meetX-2&&m.x<o-1?p.scriptedTargetVx=3:(p.scriptedTargetVx=0,Math.abs(m.x-t.meetX)<6&&(m.x=t.meetX),t.phase="talk"))}if("talk"===t.phase){p.cameraOverrideX=r,p.scriptedTargetVx=0,t.triggeredDialogue||(t.triggeredDialogue=!0,x("FINAL_PUZZLE_COMPLETE"));let e=!p.monologue.activeLine&&0===p.monologue.queue.length;return void(t.triggeredDialogue&&e&&(t.fading=!0,t.phase="fade"))}"fade"===t.phase&&(p.scriptedTargetVx=0,t.fadeAlpha=Math.min(1,(t.fadeAlpha||0)+.01),t.fadeAlpha>=1&&(t.active=!1,p.credits.active||S()))}()}function _(t){let o=e.getBoundingClientRect();return{x:(t.clientX-o.left)*(e.width/o.width),y:(t.clientY-o.top)*(e.height/o.height)}}function k(e,t,o){return t>=e.x&&t<=e.x+e.w&&o>=e.y&&o<=e.y+e.h}function R(){if(p.monologue.ready){if(p.monologue.activeLine)p.monologue.timer--,p.monologue.timer<=0&&(p.monologue.activeLine=null);else if(p.monologue.queue.length>0){let e=p.monologue.queue.shift();p.monologue.activeLine=e,p.monologue.timer=e.duration,b("text"),function(e){!e||!e.beatId||"control_room"===p.currentRoom&&("l4_voice_04"===e.beatId&&(p.flags&&(p.flags.tvMode="static"),p.tvOverlayKey=null),"l4_voice_05"===e.beatId&&(p.cutsceneAnimSprite=m.sprites.forward))}(e)}if(p.pendingRoomSwitch&&!p.transition.active&&!p.monologue.activeLine&&0===p.monologue.queue.length&&Date.now()>=p.pendingRoomSwitch.at){let{targetKey:e,spawnX:t}=p.pendingRoomSwitch;return p.pendingRoomSwitch=null,void O(e,t)}if(!p.introActive&&!p.isPhoneLocked&&!p.isPosterLocked)if(Math.abs(m.velocityX)>.5)p.monologue.walkTime++,p.monologue.idleTime=0,p.monologue.hasMoved||(p.monologue.hasMoved=!0,x("PLAYER_FIRST_MOVE")),300===p.monologue.walkTime&&x("WALKING_5S"),480===p.monologue.walkTime&&x("WALKING_8S"),720===p.monologue.walkTime&&x("WALKING_12S"),960===p.monologue.walkTime&&x("WALKING_16S");else if(p.monologue.idleTime++,p.monologue.walkTime=0,p.monologue.idleTime>=p.monologue.idleThreshold&&(p.monologue.idleTime=0,p.monologue.idleThreshold=360+Math.floor(1440*Math.random()),p.monologue.data&&p.monologue.data.beats)){let e=p.monologue.data.beats.filter(e=>e.id.startsWith("idle_")&&!p.monologue.history.includes(e.id));if(e.length>0){x(e[Math.floor(Math.random()*e.length)].event)}}}else window.LEVEL_DATA&&(p.monologue.data=window.LEVEL_DATA,p.monologue.ready=!0)}function E(){if(p.cutsceneAnimSprite)return p.cutsceneAnimSprite;if(p.forceForwardFrames&&p.forceForwardFrames>0)return m.sprites.forward;if(p.phoneAnimSprite)return p.phoneAnimSprite;if(p.posterAnimSprite)return p.posterAnimSprite;if("DYING"===p.health.state||"DEAD"===p.health.state)return p.health.deathTimer<60?m.sprites.death1:p.health.deathTimer<120?m.sprites.death2:m.sprites.death3;if(p.introActive)return"wait"===p.introPhase?m.sprites.sleep:p.introTimer<60?m.sprites.kneel1:m.sprites.kneel2;if(m.isInteracting)return m.sprites.pickup;if(!m.isGrounded)return m.sprites.jump&&m.sprites.jump.complete&&m.sprites.jump.naturalWidth>0?m.sprites.jump:m.sprites.forward;if(0===m.velocityX)return m.sprites.forward;if(Math.abs(m.velocityX)>m.speed+1){let e=m.animationFrame%4;return 0===e?m.sprites.runRight1:1===e?m.sprites.runRight3:2===e?m.sprites.runRight2:m.sprites.runRight3}return m.animationFrame%2==0?m.sprites.walkRight1:m.sprites.walkRight2}function P(){var t,o;if(p.credits&&p.credits.active)return void(p.credits.active&&"ROLL"===p.credits.state&&(p.credits.scrollY-=p.credits.speed,p.credits.scrollY+p.credits.totalHeight<-40&&(p.credits.state="DONE")));if(p.settingsOpen||p.paused)return;if(p.overlayOpen||p.controlPanelOpen||p.posterAssembleOpen)return R(),void("outside"===p.currentRoom&&T());if(p.forceForwardFrames&&p.forceForwardFrames>0&&p.forceForwardFrames--,p.cutsceneLocked)return m.velocityX=0,m.velocityY=0,R(),void(!p.monologue.activeLine&&0===p.monologue.queue.length&&(p.cutsceneLocked=!1,p.cutsceneAnimSprite=null,p.forceForwardFrames=20,p.keys={},m.velocityX=0));if(p.transition.active)return void function(){if(p.transition.active)if("IN"===p.transition.state)p.transition.alpha+=.05,p.transition.alpha>=1&&(p.transition.alpha=1,p.transition.state="LOAD");else if("LOAD"===p.transition.state){let e=p.rooms[p.currentRoom];p.currentRoom=p.transition.targetRoom;let t=p.rooms[p.currentRoom];f(),e.music!==t.music&&(v(e.music),y(t.music)),p.backgroundLoaded=!1,p.background.src=h(p.currentRoom),m.x=p.transition.spawnX,p.platformY=t.platformY||230,m.y=p.platformY,m.velocityX=0,p.cameraOverrideX=null,p.controlsLocked=!1,p.scriptedTargetVx=0,p.posterAssembleOpen=!1,p.posterAssemble&&(p.posterAssemble.draggingId=null,p.posterAssemble.pendingCutscene=!1,p.posterAssemble.completed=!1),p.dadNpc&&(p.dadNpc.visible=!1),p.dadCutscene&&(p.dadCutscene.active=!1),p.objects=[...t.objects],window.LEVELS&&window.LEVELS[p.currentRoom]?(p.monologue.data=window.LEVELS[p.currentRoom],p.monologue.ready=!0,p.monologue.roomHistory||(p.monologue.roomHistory={}),p.monologue.roomHistory[p.currentRoom]||(p.monologue.roomHistory[p.currentRoom]=[]),p.monologue.history=p.monologue.roomHistory[p.currentRoom],p.monologue.queue=[],p.monologue.activeLine=null,p.monologue.hasHitWall=!1,setTimeout(()=>x("LEVEL_START"),100)):(p.monologue.data=null,p.monologue.ready=!1,p.monologue.queue=[],p.monologue.activeLine=null,p.monologue.hasHitWall=!1),p.transition.state="WAIT_BG"}else"WAIT_BG"===p.transition.state?p.backgroundLoaded&&(p.transition.state="OUT"):"OUT"===p.transition.state&&(p.transition.alpha-=.05,p.transition.alpha<=0&&(p.transition.alpha=0,p.transition.active=!1))}();let r=p.rooms[p.currentRoom];if(r&&r.exits&&r.exits.forEach(e=>{let t=e.x+e.w/2,o=m.x+m.width/2;if(Math.abs(t-o)<80){if(e.hovered=!0,"zone"===e.type)p.rooms[e.target]&&O(e.target,e.spawnX);else if("door"===e.type){let t=p.keys.ArrowUp;(p.keys.KeyE||"up"===e.dir&&t)&&(O(e.target,e.spawnX),p.keys.Space=!1,p.keys.ArrowUp=!1)}}else e.hovered=!1}),"DYING"===p.health.state)return p.health.deathTimer++,m.velocityX=0,void(p.health.deathTimer>180&&(p.health.state="DEAD"));if("DEAD"===p.health.state)return void(p.health.fadeAlpha<1&&(p.health.fadeAlpha+=.01));if(!p.introActive){p.health.current--;let e=p.health.current/p.health.maxTime*100;p.health.percentage>=60&&e<60&&x("HEALTH_BELOW_60"),p.health.percentage>=30&&e<30&&x("HEALTH_BELOW_30"),p.health.percentage>=1&&e<1&&x("HEALTH_BELOW_1"),p.health.percentage=e,p.health.current<=0&&(p.health.state="DYING")}if(R(),"hallway"===p.currentRoom&&("WAITING"===p.phoneState&&Math.abs(m.x-i)>300&&(p.phoneState="READY_TO_RING",p.phoneTimer=120,x("LEFT_PHONE_AREA_AFTER_DEAD")),"READY_TO_RING"===p.phoneState&&(p.phoneTimer--,p.phoneTimer<=0&&(p.phoneState="RINGED_ONCE",x("PHONE_RINGED_ONCE"),p.activeRing||(p.activeRing=new Audio("assets/sounds/phone-ring.mp3")),p.activeRing.currentTime=0,p.activeRing.loop=!1,p.activeRing.play().catch(()=>{}),setTimeout(()=>{"RINGED_ONCE"===p.phoneState&&p.activeRing&&(p.activeRing.pause(),p.phoneState="RINGING_LOOP",p.activeRing.loop=!0,p.activeRing.play().catch(e=>{}))},2e3))),"ANSWERED"===p.phoneState&&0===p.monologue.queue.length&&!p.monologue.activeLine&&(p.phoneState="HANGING_UP",b("ui-cancel"),p.phoneAnimSprite=m.sprites.reach,setTimeout(()=>{p.phoneAnimSprite=m.sprites.back,setTimeout(()=>{p.phoneAnimSprite=null,p.isPhoneLocked=!1,p.phoneState="FINISHED",x("AFTER_PHONE_CALL")},500)},500))),"ticket_hall"===p.currentRoom&&(m.x>1e3&&x("SEE_CONTROL_ROOM_DOOR"),m.x>900&&x("VOICE_INTERRUPT"),m.x>1150&&x("NEAR_CONTROL_ROOM_END")),"outside"===p.currentRoom&&T(),m.y>=p.platformY-.1&&m.velocityY>=0?(m.isGrounded=!0,m.y=p.platformY,m.velocityY=0):m.isGrounded=!1,p.isPhoneLocked||p.isPosterLocked)return m.velocityX=0,m.velocityY+=p.gravity,void(m.y>=p.platformY&&(m.y=p.platformY,m.velocityY=0,m.isGrounded=!0));let l=0;if(p.introActive)"waking"===p.introPhase&&(p.introTimer++,p.introTimer>120&&(p.introActive=!1)),l=0;else if(m.isInteracting)m.interactionTimer--,m.interactionTimer<=0&&(m.isInteracting=!1),l=0;else if(p.controlsLocked)l=p.scriptedTargetVx||0;else{let e=p.keys.ShiftLeft||p.keys.ShiftRight?m.runSpeed:m.speed;(p.keys.ArrowLeft||p.keys.KeyA)&&(l=-e,m.direction="left"),(p.keys.ArrowRight||p.keys.KeyD)&&(l=e,m.direction="right")}m.isGrounded||0!==l?m.velocityX=l:(m.velocityX*=.85,Math.abs(m.velocityX)<.1&&(m.velocityX=0));let n=p.keys.Space||p.keys.ArrowUp;if(n||(m.canJump=!0),!m.isInteracting&&!p.introActive&&n&&m.isGrounded&&m.canJump&&(m.velocityY=m.jumpPower,m.isGrounded=!1,m.canJump=!1,b("jump")),m.velocityY+=p.gravity,m.x+=m.velocityX,m.y+=m.velocityY,m.y>p.platformY&&(m.y=p.platformY,m.velocityY=0,m.isGrounded=!0),0!==m.velocityX){m.animationTimer++;let e=Math.abs(m.velocityX)>m.speed+1?8:10;m.animationTimer>=e&&(m.animationTimer=0,m.animationFrame=(m.animationFrame+1)%4)}else m.animationTimer=0,m.animationFrame=0;if(p.backgroundLoaded){let r=E();if(r&&r.complete){let i=.3*r.naturalWidth;if(m.x<0&&(m.x=0,x("TRY_EXIT_BLOCKED")),p.background&&p.background.naturalWidth&&(p.backgroundWidth=p.background.naturalWidth*p.backgroundScale),"hallway"===p.currentRoom){let e=p.rooms.hallway.exits.find(e=>"ticket_hall"===e.target);e&&(e.x=p.backgroundWidth-150)}if("ticket_hall"===p.currentRoom){let e=null==(o=null==(t=p.rooms.ticket_hall)?void 0:t.objects)?void 0:o.find(e=>"ticket_gates"===e.type);e&&(e.x=Math.max(0,p.backgroundWidth-360))}let l=p.backgroundWidth-i;m.x>l&&(m.x=l,x("TRY_EXIT_BLOCKED"));let n=e.width/2,a=.5*m.width||.5*i,s=null!==p.cameraOverrideX?p.cameraOverrideX:m.x-n+a,c=Math.max(0,p.backgroundWidth-e.width);s<0&&(s=0),s>c&&(s=c),p.cameraX+=.2*(s-p.cameraX),p.cameraX<0&&(p.cameraX=0),p.cameraX>c&&(p.cameraX=c)}}p.objects.forEach(e=>{let t=m.x+m.width/2,o=e.x+e.width/2,r=Math.abs(t-o);e.hovered=r<60,"poster"===e.type&&(e.interactCount||0)<1&&(e.hovered=!1)}),m.velocityX*=.8,Math.abs(m.velocityX)<.5&&(m.velocityX=0),m.velocityY+=.8,m.y+=m.velocityY,p.backgroundLoaded&&p.backgroundWidth>0&&(m.x<0&&(m.x=0,Math.abs(m.velocityX)>.5&&!p.monologue.hasHitWall&&(p.monologue.hasHitWall=!0,x("TRY_EXIT_BLOCKED"))),m.x>p.backgroundWidth-m.width&&(m.x=p.backgroundWidth-m.width))}function O(e,t){p.transition.active||p.rooms[e]&&(p.transition.active=!0,p.transition.state="IN",p.transition.alpha=0,p.transition.targetRoom=e,p.transition.spawnX=t)}function L(){p.tvOverlayEl&&("control_room"!==p.currentRoom||p.controlPanelOpen)&&(p.tvOverlayEl.style.display="none"),t.imageSmoothingEnabled=!1,t.clearRect(0,0,e.width,e.height);e.height;if(p.backgroundLoaded){p.backgroundWidth;let o=p.cameraX/p.backgroundScale,r=0,i=e.width/p.backgroundScale,l=p.background.height;t.drawImage(p.background,o,r,i,l,0,0,e.width,e.height)}"control_room"===p.currentRoom&&function(){var t,o;let r=function(){if(p.tvOverlayEl)return p.tvOverlayEl;let e=document.querySelector(".game-container");if(!e)return null;let t=document.createElement("img");return t.className="tv-overlay",t.alt="TV",t.decoding="async",t.style.display="none",e.appendChild(t),p.tvOverlayEl=t,t}();if(!r)return;if("control_room"!==p.currentRoom||p.controlPanelOpen)return void(r.style.display="none");let i=p.background;if(!i||!i.complete||i.naturalWidth<=0||i.naturalHeight<=0)return void(r.style.display="none");let u="hospital"===(null==(t=p.flags)?void 0:t.tvMode)?"tv_hospital":"tv_static",h=p.objectSprites[u],f=null==h?void 0:h.src;if(!f)return void(r.style.display="none");let m=i.naturalWidth*l*p.backgroundScale-p.cameraX+c,g=i.naturalHeight*n*p.backgroundScale+d,y=i.naturalWidth*a*p.backgroundScale,v=i.naturalHeight*s*p.backgroundScale,b=e.getBoundingClientRect(),w=null==(o=document.querySelector(".game-container"))?void 0:o.getBoundingClientRect();if(!w)return;let S=b.width/e.width,x=b.height/e.height,A=b.left-w.left+m*S,T=b.top-w.top+g*x;p.tvOverlayKey!==u&&(p.tvOverlayKey=u,r.dataset.src=f,r.src=f),r.style.display="block",r.style.left=`${A}px`,r.style.top=`${T}px`,r.style.width=y*S+"px",r.style.height=v*x+"px"}(),p.rooms[p.currentRoom].objects&&p.objects.forEach(o=>{if(!1===o.visible)return;let r=Math.floor(o.x-p.cameraX),i=Math.floor(o.y);if(r+o.width<0||r>e.width)return;t.save(),o.hovered&&(t.shadowColor="#fbbf24",t.shadowBlur=15);let l=p.objectSprites[o.type];l&&l.complete&&l.naturalWidth>0?("phone"===o.type&&("RINGING_LOOP"===p.phoneState||"RINGED_ONCE"===p.phoneState)&&(t.shadowColor="#fbbf24",t.shadowBlur=20),t.drawImage(l,r,i,o.width,o.height),t.shadowBlur=0):(t.fillStyle=o.color||"#ef4444",t.fillRect(r,i,o.width,o.height)),t.restore()}),function(){var o;if("outside"!==p.currentRoom||null==(o=p.dadNpc)||!o.visible)return;let r=p.objectSprites.character_dad;if(!r||!r.complete||!r.naturalWidth)return;let i=Math.floor(.22*r.naturalWidth),l=Math.floor(.22*r.naturalHeight),n=Math.floor(p.platformY+m.height)-l,a=Math.floor(p.dadNpc.x-p.cameraX-i/2);a+i<0||a>e.width||t.drawImage(r,a,n,i,l)}();let o=E();if(o&&o.complete){t.save();let e=o.naturalWidth,r=o.naturalHeight,i="control_room"===p.currentRoom?1.2:1,l=.3*i;!!(p.phoneAnimSprite||p.posterAnimSprite||p.cutsceneAnimSprite)&&(l=.42*i),"control_room"===p.currentRoom&&o===m.sprites.back&&(l*=1.1);let n=Math.floor(e*l),a=Math.floor(r*l),s=Math.floor(m.x-p.cameraX+m.width/2),c=Math.floor(m.y+m.height),d=c-a,u=Math.floor(s-n/2),h=0,f=0;o===m.sprites.runRight1&&(f=0,h=0),o===m.sprites.runRight2&&(f=30,h=0),o===m.sprites.runRight3&&(f=50,h=0),o===m.sprites.jump&&(h=20),(o===m.sprites.pickup||o===m.sprites.kneel1||o===m.sprites.kneel2||o===m.sprites.death1||o===m.sprites.death2||o===m.sprites.death3)&&(f=35),o===m.sprites.sleep&&(f=15),"left"===m.direction?(t.translate(s,c),t.scale(-1,1),t.drawImage(o,-Math.floor(n/2)+h,-a+f,n,a)):t.drawImage(o,u+h,d+f,n,a),t.restore()}(function(){let e=p.rooms[p.currentRoom];!e||!e.exits||e.exits.forEach(e=>{if(e.hovered&&"door"===e.type){let o=Math.floor(e.x-p.cameraX+e.w/2-10+(e.indicatorOffsetX||0)),r=Math.floor(p.platformY-120),i=5*Math.sin(Date.now()/200);t.fillStyle="#fbbf24",t.beginPath(),"right"===e.dir?(t.moveTo(o,r+i-10),t.lineTo(o,r+i+10),t.lineTo(o+20,r+i)):"left"===e.dir?(t.moveTo(o+20,r+i-10),t.lineTo(o+20,r+i+10),t.lineTo(o,r+i)):"down"===e.dir?(t.moveTo(o,r+i),t.lineTo(o+20,r+i),t.lineTo(o+10,r+12+i)):(t.moveTo(o,r+i),t.lineTo(o+20,r+i),t.lineTo(o+10,r-10+i)),t.fill(),t.fillStyle="#fff",t.font='10px "Press Start 2P"',t.textAlign="center",t.fillText(e.label||"ENTER",o+10,r-15+i)}})})(),function(){if(!p.objects||0===p.objects.length)return;if("outside"===p.currentRoom){let e=p.objects.find(e=>"bus_stop"===e.type);if(e&&e.hovered){let o=Math.floor(e.x-p.cameraX+e.width/2-10),r=Math.floor(e.y-70),i=5*Math.sin(Date.now()/200);t.fillStyle="#fbbf24",t.beginPath(),t.moveTo(o,r+i),t.lineTo(o+20,r+i),t.lineTo(o+10,r-10+i),t.fill(),t.fillStyle="#fff",t.font='10px "Press Start 2P"',t.textAlign="center",t.fillText("Bus Stop",o+10,r-15+i)}return}if("ticket_hall"===p.currentRoom){let e=p.objects.find(e=>"ticket_gates"===e.type);if(e&&e.hovered){let o=Math.floor(e.x-p.cameraX+e.width/2-10-100),r=Math.floor(e.y-70),i=5*Math.sin(Date.now()/200);t.fillStyle="#fbbf24",t.beginPath(),t.moveTo(o,r+i),t.lineTo(o+20,r+i),t.lineTo(o+10,r-10+i),t.fill(),t.fillStyle="#fff",t.font='10px "Press Start 2P"',t.textAlign="center",t.fillText("Ticket Gates",o+10,r-15+i)}return}if("control_room"!==p.currentRoom)return;let e=p.objects.find(e=>"control_desk"===e.type);if(!e||!e.hovered)return;let o=Math.floor(e.x-p.cameraX+e.width/2-10),r=Math.floor(e.y-70),i=5*Math.sin(Date.now()/200);t.fillStyle="#fbbf24",t.beginPath(),t.moveTo(o,r+i),t.lineTo(o+20,r+i),t.lineTo(o+10,r+12+i),t.fill(),t.fillStyle="#fff",t.font='10px "Press Start 2P"',t.textAlign="center",t.fillText("Control Panel",o+10,r-15+i)}(),!p.controlPanelOpen&&!p.posterAssembleOpen&&function(){var o;let r=e.height-130,i=300,l=110,n=80,a=e.width-40,s=l;t.fillStyle="rgba(15, 23, 42, 0.9)",t.fillRect(20,r,a,s),t.strokeStyle="#eab308",t.lineWidth=4,t.strokeRect(20,r,a,s),t.strokeStyle="#334155",t.lineWidth=2,t.strokeRect(24,r+4,a-8,s-8);let c=35,d=r+15;if(t.fillStyle="#000",t.fillRect(c,d,n,n),t.strokeStyle="#fff",t.lineWidth=2,t.strokeRect(c,d,n,n),m.sprites.forward&&m.sprites.forward.complete){let e=m.sprites.forward;t.drawImage(e,0,0,e.naturalWidth,.4*e.naturalHeight,c,d,n,n)}t.fillStyle="#fff",t.font='20px "Press Start 2P"',t.textAlign="left",t.textBaseline="top",t.fillText("JACK",c+n+20,d);let u=c+n+20,h=d+35,f=150,g=15;t.fillStyle="#333",t.fillRect(u,h,f,g),t.fillStyle="#22c55e",t.fillRect(u,h,1*f,g),t.fillStyle="#334155",t.fillRect(u,h,f,g),p.health.percentage<30?t.fillStyle="#ef4444":p.health.percentage<60?t.fillStyle="#f59e0b":t.fillStyle="#22c55e";let y=Math.max(0,f*(p.health.percentage/100));t.fillRect(u,h,y,g),t.strokeStyle="#fff",t.lineWidth=1,t.strokeRect(u,h,f,g),t.fillStyle="#94a3b8",t.font='10px "Press Start 2P"',t.fillText(`HP: ${Math.ceil(p.health.percentage)}/100`,u,h+g+7);let v=5,b=14,w=20+i+750,S=20+a-w-10,x=Math.floor((S-b*(v+1))/v);x=Math.max(64,Math.min(86,x));let A=v*x+b*(v+1),T=w+Math.max(0,Math.floor((S-A)/2)),_=r+Math.floor((s-x)/2),k=T+b-14,R=_+Math.floor(x/2);t.save(),t.fillStyle="#94a3b8",t.font='10px "Press Start 2P"',t.textAlign="right",t.textBaseline="middle",t.fillText("INVENTORY",k,R),t.restore(),t.lineWidth=3;for(let e=0;e<v;e++){let o=T+b+e*(x+b),r=_;if(t.strokeStyle="#334155",e===p.activeSlot&&(t.strokeStyle="#fbbf24"),t.strokeRect(o,r,x,x),t.fillStyle="#64748b",t.font='10px "Press Start 2P"',t.textAlign="left",t.fillText(String(e+1),o+6,r+14),p.inventory[e]){let i=p.inventory[e].type,l=p.objectSprites[i];l&&l.complete&&t.drawImage(l,o+10,r+10,x-20,x-20)}}if(p.monologue.activeLine){let r=void 0!==p.monologue.activeLine.text?p.monologue.activeLine.text:p.monologue.activeLine,i="string"==typeof r?r:"",l=p.monologue.activeLine.meta||(null==(o=p.monologue.queue[0])?void 0:o.meta),n=e.width/2,a=e.height-180;t.save(),t.globalAlpha=1,t.textAlign="center",t.font='20px "Press Start 2P"',""!==i&&(t.fillStyle="rgba(0,0,0,0.8)",t.fillText(i,n+2,a+2)),l&&l.color?t.fillStyle=l.color:l&&"VOICE"===l.speaker?t.fillStyle="#39ff14":t.fillStyle="#ff00ff",""!==i&&t.fillText(i,n,a),t.restore()}}(),p.transition.active&&(t.fillStyle=`rgba(0,0,0,${p.transition.alpha})`,t.fillRect(0,0,e.width,e.height)),p.introActive&&"wait"===p.introPhase&&(p.introTextPlayed||(b("text"),p.introTextPlayed=!0),t.fillStyle="#fff",t.font='20px "Press Start 2P"',t.textAlign="center",t.fillText("WAKE UP, JACK - PRESS E",e.width/2,e.height/2-100)),("DEAD"===p.health.state||"DYING"===p.health.state)&&function(){if(("DEAD"===p.health.state||"DYING"===p.health.state)&&(t.fillStyle=`rgba(0, 0, 0, ${p.health.fadeAlpha})`,t.fillRect(0,0,e.width,e.height),"DEAD"===p.health.state)){let o=e.width/2,r=e.height/2;t.textAlign="center",t.fillStyle="#ef4444",t.font='60px "Press Start 2P"',t.fillText("GAME OVER",o,r-20),t.fillStyle="#fff",t.font='20px "Press Start 2P"',t.fillText("PRESS ENTER TO TRY AGAIN",o,r+50)}}(),p.overlayOpen&&function(){if(!p.viewedItem)return;t.fillStyle="rgba(0, 0, 0, 0.8)",t.fillRect(0,0,e.width,e.height);let o=null;if("newspaper"===p.viewedItem.type?o=p.objectSprites.newspaper_large:"wallet"===p.viewedItem.type?o=p.objectSprites.wallet_large:"travel_card"===p.viewedItem.type?o=p.objectSprites.travel_card_large:"keycard"===p.viewedItem.type&&(o=p.objectSprites.keycard_large),o&&o.complete){let r=(e.width-o.naturalWidth)/2,i=(e.height-o.naturalHeight)/2;t.drawImage(o,r,i),t.fillStyle="#fff",t.font='15px "Press Start 2P"',t.textAlign="center",t.fillText("Press O to Close",e.width/2,i+o.naturalHeight+30)}else t.fillStyle="#fff",t.font='20px "Press Start 2P"',t.textAlign="center",t.fillText(`Viewing: ${p.viewedItem.name}`,e.width/2,e.height/2),t.font='15px "Press Start 2P"',t.fillText("Press O to Close",e.width/2,e.height/2+30)}(),p.posterAssembleOpen&&(function(){if(!p.posterAssembleOpen)return;t.fillStyle="rgba(0, 0, 0, 0.82)",t.fillRect(0,0,e.width,e.height);let o=p.posterAssemble.board;o&&(t.strokeStyle="#fbbf24",t.lineWidth=3,t.strokeRect(o.x,o.y,o.w,o.h)),(p.posterAssemble.pieces||[]).forEach(e=>{let o=p.objectSprites[e.key];o&&o.complete&&o.naturalWidth?t.drawImage(o,e.x,e.y,e.w,e.h):(t.fillStyle="#334155",t.fillRect(e.x,e.y,e.w,e.h)),e.locked&&(t.strokeStyle="rgba(34,197,94,0.9)",t.lineWidth=2,t.strokeRect(e.x,e.y,e.w,e.h))}),t.fillStyle="#fff",t.font='14px "Press Start 2P"',t.textAlign="center",t.fillText("Assemble the Poster",e.width/2,40),t.font='10px "Press Start 2P"',t.fillStyle="#94a3b8",t.fillText("Drag pieces into place  â€¢  Esc to close",e.width/2,62)}(),I()),p.controlPanelOpen&&(function(){let o=p.objectSprites.control_panel_bg;if(o&&o.complete&&o.naturalWidth>0){let e=D(o);t.drawImage(o,e.x,e.y,e.w,e.h)}else t.fillStyle="#000",t.fillRect(0,0,e.width,e.height);let r=function(){let e=p.objectSprites.control_panel_bg,t=D(e),o={sys:{u:.52,v:.37,s:.14},yellow:{u:.64,v:.34,s:.07},blue:{u:.71,v:.34,s:.07},green:{u:.79,v:.34,s:.07}},r=Math.min(t.w,t.h),i=({u:e,v:o,s:i})=>{let l=Math.round(r*i);return{x:t.x+t.w*e,y:t.y+t.h*o,w:l,h:l}};return{sys:i(o.sys),yellow:i(o.yellow),blue:i(o.blue),green:i(o.green)}}(),i=["yellow","blue","green","sys"][p.controlPanel.selectedIndex],l={yellow:{dx:0,dy:0,scale:1.8},blue:{dx:0,dy:0,scale:1.8},green:{dx:0,dy:0,scale:1.8},sys:{dx:0,dy:0,scale:2.5}},n=(e,o,r,i)=>{let n=p.objectSprites[o],a=p.objectSprites[r];if(!a||!a.complete)return;let s=e.w,c=e.h,d=r!==o&&i&&l[i]?l[i]:{dx:0,dy:0,scale:1};if(n&&n.complete&&n.naturalWidth>0&&n.naturalHeight>0&&a.naturalWidth>0&&a.naturalHeight>0){let t=n.naturalWidth/a.naturalWidth,o=n.naturalHeight/a.naturalHeight;s=e.w*t,c=e.h*o}s*=d.scale,c*=d.scale,t.drawImage(a,e.x+d.dx-s/2,e.y+d.dy-c/2,s,c)},a=M(),s=p.controlPanel.systemStarted||a?"sys_start_glow":"sys_start";n(r.yellow,"button_yellow",p.controlPanel.yellowOn?"button_yellow_glow":"button_yellow","yellow"),n(r.blue,"button_blue",p.controlPanel.blueOn?"button_blue_glow":"button_blue","blue"),n(r.green,"button_green",p.controlPanel.greenOn?"button_green_glow":"button_green","green"),n(r.sys,"sys_start",s,"sys");let c=r[i];c&&(t.save(),t.strokeStyle="#fbbf24",t.lineWidth=3,t.strokeRect(c.x-c.w/2-6,c.y-c.h/2-6,c.w+12,c.h+12),t.restore()),t.save(),t.fillStyle="#fff",t.font='12px "Press Start 2P"',t.textAlign="center",t.fillText("[ARROWS/WASD] SELECT   [E/SPACE] PRESS   [ESC] EXIT",e.width/2,e.height-20),t.restore()}(),I()),"outside"===p.currentRoom&&p.dadCutscene&&p.dadCutscene.fadeAlpha&&(t.fillStyle=`rgba(0,0,0,${p.dadCutscene.fadeAlpha})`,t.fillRect(0,0,e.width,e.height)),p.credits&&p.credits.active&&function(){if(!p.credits.active)return;t.save(),t.fillStyle="#000",t.fillRect(0,0,e.width,e.height),t.restore();let o=e.width/2,r=Math.max(200,e.width-220);if("DONE"===p.credits.state)return t.save(),t.textAlign="center",t.textBaseline="middle",t.fillStyle="#fff",t.font='36px "Press Start 2P"',t.fillText("THE END",o,e.height/2-20),t.fillStyle="#94a3b8",t.font='14px "Press Start 2P"',t.fillText("PRESS ENTER TO RESTART",o,e.height/2+40),void t.restore();let i=p.credits.scrollY;for(let l of p.credits.lines){if("spacer"===l.type){i+=l.h||0;continue}let n=12,a=18,s="#fff";"title"===l.type?(n=42,a=54):"subtitle"===l.type?(n=16,a=26,s="#94a3b8"):"header"===l.type?(n=18,a=30,s="#fbbf24"):"name"===l.type?(n=14,a=24,s="#fff"):"role"===l.type&&(n=11,a=18,s="#94a3b8");let c=`${n}px "Press Start 2P"`,d=w(l.text,r,c);t.save(),t.textAlign="center",t.textBaseline="top",t.fillStyle=s,t.font=c;for(let r of d)i>-100&&i<e.height+100&&t.fillText(r,o,i),i+=a;t.restore()}}(),p.settingsOpen&&function(){t.fillStyle="rgba(0, 0, 0, 0.78)",t.fillRect(0,0,e.width,e.height);let o=p.settingsPage||"audio",r=Math.min(980,e.width-140),i=Math.min(520,e.height-120),l=Math.floor((e.width-r)/2),n=Math.floor((e.height-i)/2),a=32,s=110;t.save(),t.fillStyle="rgba(15, 23, 42, 0.96)",t.fillRect(l,n,r,i),t.strokeStyle="#eab308",t.lineWidth=4,t.strokeRect(l,n,r,i),t.strokeStyle="#334155",t.lineWidth=2,t.strokeRect(l+6,n+6,r-12,i-12),t.restore();let c=n+46;t.save(),t.textBaseline="middle",t.textAlign="left",t.fillStyle="#fff",t.font='28px "Press Start 2P"',t.fillText("SETTINGS",l+a,c),t.textAlign="right",t.fillStyle="#94a3b8",t.font='12px "Press Start 2P"',t.fillText("ESC: CLOSE",l+r-a,c),t.restore();let d=n+72,u=34,h=210,f=14,m=l+Math.floor((r-(2*h+f))/2),g=(e,o,r)=>{t.save(),t.fillStyle=r?"rgba(251, 191, 36, 0.22)":"rgba(30, 41, 59, 0.85)",t.fillRect(o,d,h,u),t.strokeStyle=r?"#fbbf24":"#334155",t.lineWidth=2,t.strokeRect(o,d,h,u),t.fillStyle=r?"#fbbf24":"#cbd5e1",t.font='14px "Press Start 2P"',t.textAlign="center",t.textBaseline="middle",t.fillText(e,o+h/2,d+u/2),t.restore()};g("AUDIO",m,"audio"===o),g("CONTROLS",m+h+f,"controls"===o),t.save(),t.strokeStyle="#334155",t.lineWidth=2,t.beginPath(),t.moveTo(l+a,n+s),t.lineTo(l+r-a,n+s),t.stroke(),t.restore();let y=l+a,v=n+s+26,b=r-2*a,w=n+i-34;if(t.save(),t.textAlign="center",t.textBaseline="middle",t.fillStyle="#64748b",t.font='12px "Press Start 2P"',t.fillText("TAB: SWITCH PAGE   \0\0   ESC: CLOSE",l+r/2,w),t.restore(),"controls"===o){t.save(),t.textAlign="left",t.textBaseline="top",t.fillStyle="#fff",t.font='18px "Press Start 2P"',t.fillText("CONTROLS",y,v),t.fillStyle="#94a3b8",t.font='12px "Press Start 2P"',t.fillText("Use these keys during gameplay:",y,v+28),t.restore();let e=v+140;!function(e,o){t.textAlign="center";let r=[{label:"ESC",w:1.5,text:"MENU"},{label:"SHIFT",w:2.2,text:"RUN"},{label:"A",w:1,text:"LEFT"},{label:"D",w:1,text:"RIGHT"},{label:"SPACE",w:3,text:"JUMP"},{label:"E",w:1,text:"ACT"},{label:"O",w:1,text:"LOOK"},{label:"P",w:1,text:"PAUSE"}],i=0;r.forEach(e=>i+=25*e.w+5),i-=5;let l=e-i/2;r.forEach((e,r)=>{let i=25*e.w,n=25,a=l,s=o-n/2;t.fillStyle="#0f172a",t.fillRect(a,s+2,i,n),t.fillStyle="#1e293b",t.fillRect(a,s,i,n),t.strokeStyle="#fbbf24",t.lineWidth=1,t.strokeRect(a,s,i,n),t.fillStyle="#fbbf24",t.font='8px "Press Start 2P"',t.fillText(e.label,a+i/2,s+n/2+4);let c=r%2==0?"up":"down",d="up"===c?s:s+n,u="up"===c?s-15:s+n+15;t.strokeStyle="#64748b",t.beginPath(),t.moveTo(a+i/2,d),t.lineTo(a+i/2,u),t.stroke(),t.fillStyle="#94a3b8",t.fillText(e.text,a+i/2,"up"===c?u-5:u+8),l+=i+5})}(l+r/2,e);let o=e+70;t.save(),t.textAlign="left",t.textBaseline="top",t.fillStyle="#cbd5e1",t.font='12px "Press Start 2P"';let i=["MOVE: A/D or \0/\0","RUN: SHIFT","JUMP: SPACE","INTERACT: E","INVENTORY LOOK: O","PAUSE: P"],n=40,a=y,s=y+Math.floor((b-n)/2)+n;for(let e=0;e<i.length;e++){let r=e<3?a:s,l=o+e%3*22;t.fillText(i[e],r,l)}return void t.restore()}let S=p.music.platform.volume,x=!!p.music.platform.muted,A=Math.max(0,Math.min(1,S));t.save(),t.textAlign="left",t.textBaseline="top",t.fillStyle="#fff",t.font='18px "Press Start 2P"',t.fillText("AUDIO",y,v),t.fillStyle="#94a3b8",t.font='12px "Press Start 2P"',t.fillText("Master Volume",y,v+34),t.textAlign="right",t.fillStyle=x?"#ef4444":"#cbd5e1",t.font='12px "Press Start 2P"',t.fillText(x?"MUTED":`${Math.round(100*A)}%`,y+b,v+34),t.restore();let T=y,_=v+66,k=b,R=18,E=Math.max(0,Math.floor(k*A)),P=T+E;t.save(),t.fillStyle="#0b1220",t.fillRect(T,_,k,R),t.strokeStyle="#334155",t.lineWidth=2,t.strokeRect(T,_,k,R),t.fillStyle=x?"#475569":"#fbbf24",E>0&&t.fillRect(T,_,E,R),t.fillStyle="#fff",t.fillRect(Math.max(T,Math.min(T+k-4,P-2)),_-4,4,R+8),t.restore(),t.save(),t.textAlign="left",t.textBaseline="top",t.fillStyle="#64748b",t.font='12px "Press Start 2P"',t.fillText("\0/\0: ADJUST   M: MUTE",y,_+34),t.restore()}(),p.paused&&function(){t.fillStyle="rgba(0, 0, 0, 0.7)",t.fillRect(0,0,e.width,e.height);let o=e.width/2,r=e.height/2;(function(e=40,o=60,r="left",i=400){if(!p.logo.complete)return;t.save();let l=i,n=p.logo.naturalHeight/p.logo.naturalWidth,a=l,s=l*n,c=e,d=o;"center"===r&&(c=e-a/2),t.drawImage(p.logo,c,d,a,s),t.restore()})(o,r-50,"center"),t.fillStyle="#fbbf24",t.textAlign="center",t.font='20px "Press Start 2P"',t.fillText("PAUSED",o,r+20),t.fillStyle="#94a3b8",t.font='12px "Press Start 2P"',t.fillText("PRESS P TO RESUME",o,r+60)}(),(!p.backgroundLoaded||m.spritesLoaded<4)&&(t.fillStyle="#fff",t.font='20px "Press Start 2P"',t.textAlign="center",t.fillText("Loading...",e.width/2,e.height/2))}function I(){var o;if(!p.monologue.activeLine)return;let r=void 0!==p.monologue.activeLine.text?p.monologue.activeLine.text:p.monologue.activeLine,i="string"==typeof r?r:"",l=p.monologue.activeLine.meta||(null==(o=p.monologue.queue[0])?void 0:o.meta),n=e.width/2,a=e.height-60;t.save(),t.globalAlpha=1,t.textAlign="center",t.font='20px "Press Start 2P"',""!==i&&(t.fillStyle="rgba(0,0,0,0.8)",t.fillText(i,n+2,a+2)),l&&l.color?t.fillStyle=l.color:l&&"VOICE"===l.speaker?t.fillStyle="#39ff14":t.fillStyle="#ff00ff",""!==i&&t.fillText(i,n,a),t.restore()}function M(){return!!(p.controlPanel.yellowOn&&p.controlPanel.blueOn&&p.controlPanel.greenOn)}function C(e){p.controlPanel.selectedIndex=(p.controlPanel.selectedIndex+e+4)%4,b("text")}function D(t){if(!t||!t.complete||t.naturalWidth<=0||t.naturalHeight<=0)return{x:0,y:0,w:e.width,h:e.height};let o=t.naturalWidth,r=t.naturalHeight,i=e.width,l=e.height,n=Math.max(i/o,l/r),a=o*n,s=r*n;return{x:(i-a)/2,y:(l-s)/2+40,w:a,h:s}}p.music={platform:new Audio("assets/music/platform.ogg"),hallway:new Audio("assets/music/hallway.ogg"),tickethall:new Audio("assets/music/tickethall.ogg"),control:new Audio("assets/music/control.ogg"),outside:new Audio("assets/music/outside.ogg"),endCredits:new Audio("assets/music/end-credits.ogg")},p.music.platform.loop=!0,p.music.platform.volume=.4,p.music.hallway.loop=!0,p.music.hallway.volume=.4,p.music.tickethall.loop=!0,p.music.tickethall.volume=.4,p.music.control.loop=!0,p.music.control.volume=.4,p.music.outside.loop=!0,p.music.outside.volume=.4,p.music.endCredits.loop=!0,p.music.endCredits.volume=.4,p.sfx={text:new Audio("assets/sounds/text.wav"),pickup:new Audio("assets/sounds/pickup.wav"),jump:new Audio("assets/sounds/jump.wav"),confirm:new Audio("assets/sounds/confirm.wav")},e.addEventListener("mousedown",e=>{if(!p.posterAssembleOpen)return;let{x:t,y:o}=_(e),r=p.posterAssemble.pieces||[];for(let i=r.length-1;i>=0;i--){let l=r[i];if(!l.locked&&k(l,t,o))return p.posterAssemble.draggingId=l.id,p.posterAssemble.dragOffsetX=t-l.x,p.posterAssemble.dragOffsetY=o-l.y,r.splice(i,1),r.push(l),void e.preventDefault()}}),e.addEventListener("mousemove",e=>{if(!p.posterAssembleOpen)return;let t=p.posterAssemble.draggingId;if(!t)return;let{x:o,y:r}=_(e),i=(p.posterAssemble.pieces||[]).find(e=>e.id===t);i&&(i.x=o-p.posterAssemble.dragOffsetX,i.y=r-p.posterAssemble.dragOffsetY,e.preventDefault())}),e.addEventListener("mouseup",e=>{if(!p.posterAssembleOpen)return;let t=p.posterAssemble.draggingId;if(!t)return;let o=(p.posterAssemble.pieces||[]).find(e=>e.id===t);if(p.posterAssemble.draggingId=null,!o)return;let i=null==r().snapTol?28:r().snapTol;Math.abs(o.x-o.tx)<i&&Math.abs(o.y-o.ty)<i&&(o.x=o.tx,o.y=o.ty,o.locked=!0,b("confirm"),function(){let e=p.posterAssemble.pieces;!e||0===e.length||e.some(e=>!e.locked)||(p.posterAssemble.completed=!0,p.posterAssemble.pendingCutscene=!0,x("INTERACTION_POSTER_ASSEMBLE_COMPLETE"))}()),e.preventDefault()}),p.keys={},window.addEventListener("keydown",t=>{var o,i,l;if(p.credits&&p.credits.active)return t.repeat||"Enter"!==t.code&&"Space"!==t.code||location.reload(),void t.preventDefault();if(p.controlPanelOpen){if(!t.repeat){if("ArrowLeft"===t.code||"KeyA"===t.code)return C(-1),void t.preventDefault();if("ArrowRight"===t.code||"KeyD"===t.code)return C(1),void t.preventDefault();if("ArrowUp"===t.code||"KeyW"===t.code)return C(-1),void t.preventDefault();if("ArrowDown"===t.code||"KeyS"===t.code)return C(1),void t.preventDefault();if("KeyE"===t.code||"Space"===t.code||"Enter"===t.code)return function(){let e=["yellow","blue","green","sys"][p.controlPanel.selectedIndex];if("yellow"===e)return p.controlPanel.yellowOn=!0,void b("confirm");if("blue"===e)return p.controlPanel.blueOn=!0,void b("confirm");if("green"===e)return p.controlPanel.greenOn=!0,void b("confirm");if("sys"===e){if(p.controlPanel.systemStarted)return void(p.controlPanelOpen=!1);if(!M())return x("INTERACTION_CONTROL_SYSTEM_TRY"),void b("ui-deny");p.controlPanel.systemStarted=!0,b("confirm"),setTimeout(()=>{p.controlPanelOpen=!1,p.flags&&(p.flags.stationPowerOn=!0,p.flags.tvMode="hospital"),f(),window.LEVELS&&window.LEVELS[p.currentRoom]&&(p.monologue.data=window.LEVELS[p.currentRoom],p.monologue.ready=!0,p.monologue.queue||(p.monologue.queue=[]),p.monologue.history||(p.monologue.history=[])),p.cutsceneLocked=!0,p.cutsceneAnimSprite=m.sprites.back,m.velocityX=0,p.keys={},p.tvOverlayKey=null,x("INTERACTION_CONTROL_SYSTEM_READY"),x("VOICE_INTERRUPT_TV")},900)}}(),void t.preventDefault();if("Escape"===t.code)return p.controlPanelOpen=!1,void t.preventDefault()}t.preventDefault()}else{if(p.posterAssembleOpen)return t.repeat||"Escape"!==t.code&&"KeyO"!==t.code||p.posterAssemble.completed||A(),void t.preventDefault();if("Digit1"===t.code&&(p.activeSlot=0),"Digit2"===t.code&&(p.activeSlot=1),"Digit3"===t.code&&(p.activeSlot=2),"Digit4"===t.code&&(p.activeSlot=3),"Digit5"===t.code&&(p.activeSlot=4),"KeyO"===t.code&&!t.repeat){if("ALIVE"!==p.health.state)return;if(p.overlayOpen){let e=p.overlaySourceType||(null==(o=p.viewedItem)?void 0:o.type);"newspaper"===e&&x("PICKUP_NEWSPAPER"),"wallet"===e&&x("PICKUP_WALLET"),p.overlayOpen=!1,p.viewedItem=null,p.overlaySourceType=null}else{let e=p.inventory[p.activeSlot];e&&(p.overlayOpen=!0,p.viewedItem=e,p.overlaySourceType=e.type,b("confirm"))}}if("KeyE"===t.code&&!t.repeat&&p.overlayOpen)return"wallet"===(null==(i=p.viewedItem)?void 0:i.type)?(p.inventory.some(e=>"travel_card"===(null==e?void 0:e.type))||p.inventory.length>=5||p.inventory.push({type:"travel_card",name:"Travel Card"}),p.overlaySourceType=p.overlaySourceType||"wallet",p.viewedItem={type:"travel_card",name:"Travel Card"},b("confirm"),void t.preventDefault()):void t.preventDefault();if("Escape"===t.code&&!t.repeat&&(p.paused||(p.settingsOpen=!p.settingsOpen,p.settingsOpen&&(p.settingsPage=p.settingsPage||"audio"))),"KeyP"===t.code&&!t.repeat&&(p.settingsOpen||(p.paused=!p.paused)),p.settingsOpen){if(!t.repeat&&"Tab"===t.code)return p.settingsPage="controls"===p.settingsPage?"audio":"controls",b("text"),void t.preventDefault();if("controls"!==p.settingsPage){if("ArrowLeft"===t.code){let e=Math.max(0,p.music.platform.volume-.1);return Object.values(p.music).forEach(t=>t.volume=e),void t.preventDefault()}if("ArrowRight"===t.code){let e=Math.min(1,p.music.platform.volume+.1);return Object.values(p.music).forEach(t=>t.volume=e),void t.preventDefault()}if("KeyM"===t.code&&!t.repeat){let e=!p.music.platform.muted;return Object.values(p.music).forEach(t=>t.muted=e),void t.preventDefault()}}if(["ArrowLeft","ArrowRight","ArrowUp","ArrowDown","KeyW","KeyA","KeyS","KeyD","Space","KeyE","KeyO","KeyP","KeyM","Digit1","Digit2","Digit3","Digit4","Digit5"].includes(t.code))return void t.preventDefault()}if("ALIVE"===p.health.state&&!p.cutsceneLocked&&!p.controlsLocked&&(p.keys[t.code]=!0),"DEAD"===p.health.state&&"Enter"===t.code&&location.reload(),["Space","ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].indexOf(t.code)>-1&&t.preventDefault(),"KeyE"===t.code&&!t.repeat){if(p.cutsceneLocked)return;if(p.introActive&&"wait"===p.introPhase)return p.introPhase="waking",p.introTimer=0,y((null==(l=p.rooms[p.currentRoom])?void 0:l.music)||"platform"),void x("LEVEL_START");!function(){if(m.isInteracting)return;let t=60,o=m.x+m.width/2,i=-1;for(let e=0;e<p.objects.length;e++){let r=p.objects[e],l=r.x+r.width/2;if(Math.abs(o-l)<t){i=e;break}}if(-1!==i){let t=p.objects[i];if("phone"===t.type)return void function(){if("DEAD"===p.phoneState)p.phoneState="WAITING",b("ui-deny"),p.isPhoneLocked=!0,m.velocityX=0,p.phoneAnimSprite=m.sprites.back,setTimeout(()=>{p.phoneAnimSprite=m.sprites.reach,x("PHONE_INTERACT_FIRST"),setTimeout(()=>{p.phoneAnimSprite=m.sprites.back,setTimeout(()=>{p.phoneAnimSprite=null,p.isPhoneLocked=!1},400)},1e3)},300);else if("RINGING_LOOP"===p.phoneState||"RINGED_ONCE"===p.phoneState)p.phoneState="ANSWERING",p.phoneCutPlayed=!1,p.activeRing&&(p.activeRing.pause(),p.activeRing=null),p.isPhoneLocked=!0,m.velocityX=0,p.phoneAnimSprite=m.sprites.back,setTimeout(()=>{p.phoneAnimSprite=m.sprites.reach,setTimeout(()=>{p.phoneAnimSprite=m.sprites.phoneTalk,p.phoneState="ANSWERED",x("PHONE_INTERACT_AFTER_RING")},500)},300);else if("ANSWERED"===p.phoneState&&0===p.monologue.queue.length&&!p.monologue.activeLine)p.phoneCutPlayed?(x("AFTER_PHONE_CALL"),p.phoneState="HANGING_UP",p.phoneAnimSprite=m.sprites.reach,setTimeout(()=>{p.phoneAnimSprite=m.sprites.back,setTimeout(()=>{p.phoneAnimSprite=null,p.phoneState="FINISHED",p.isPhoneLocked=!1},300)},500)):(x("PHONE_CALL_CUT"),p.phoneCutPlayed=!0)}();if("poster"===t.type)return void function(e){if(p.isPosterLocked||p.isPhoneLocked)return;e.interactCount=(e.interactCount||0)+1,e.interactCount>4&&(e.interactCount=4),p.isPosterLocked=!0,m.velocityX=0,p.posterAnimSprite=e.interactCount<4?m.sprites.back:m.sprites.reach,x(`poster_interact_0${e.interactCount}`),4===e.interactCount&&(p.inventory.some(e=>"keycard"===e.type)||p.inventory.length<5&&(p.inventory.push({type:"keycard",name:"Keycard"}),b("pickup")));let t=e.interactCount<4?650:800;setTimeout(()=>{p.posterAnimSprite=null,p.isPosterLocked=!1},t)}(t);if("ticket_gates"===t.type){let e=!(!p.flags||!p.flags.stationPowerOn),t=p.inventory.some(e=>"travel_card"===(null==e?void 0:e.type));return e?t?(x("TRY_TICKET_GATES_WITH_TRAVELCARD"),void function(e,t,o=0){p.pendingRoomSwitch={targetKey:e,spawnX:t,at:Date.now()+Math.max(0,o)}}("outside",80)):void x("TRY_TICKET_GATES_NO_TRAVELCARD"):void x("TRY_TICKET_GATES_NO_POWER")}if("bus_stop"===t.type)return void function(){var t;if(p.posterAssembleOpen||null!=(t=p.outsideState)&&t.posterGameComplete)return;p.posterAssembleOpen=!0,p.controlsLocked=!0,p.posterAssemble.completed=!1,p.posterAssemble.pendingCutscene=!1;let o=r(),i=p.objectSprites.memory_poster_completed,l=(null==i?void 0:i.naturalWidth)||600,n=(null==i?void 0:i.naturalHeight)||400,a=.78*e.width,s=.72*e.height,c=Math.min(a/l,s/n,1),d=c*(o.boardScale||1);p.posterAssemble.layout={baseScale:c};let u=Math.floor(l*d),h=Math.floor(n*d),f=Math.floor((e.width-u)/2)+(o.boardDx||0),m=Math.floor((e.height-h)/2)+(o.boardDy||0),g=Math.floor(u/3),y=Math.floor(h/2);p.posterAssemble.board={x:f,y:m,w:u,h:h},p.posterAssemble.pieces=["memory_poster_1","memory_poster_2","memory_poster_3","memory_poster_4","memory_poster_5","memory_poster_6"].map((t,r)=>{var i;let l=p.objectSprites[t],n=(null==l?void 0:l.naturalWidth)||g,a=(null==l?void 0:l.naturalHeight)||y,s=(null==(i=o.pieces)?void 0:i[t])||{tx:null,ty:null,scale:1},d=null==s.scale?1:s.scale,u=Math.max(1,Math.floor(n*c*d)),h=Math.max(1,Math.floor(a*c*d)),v=r%3,b=Math.floor(r/3),w=f+v*g,S=m+b*y,x=Math.floor(w+(g-u)/2),A=Math.floor(S+(y-h)/2),T=null==s.tx?x:s.tx,_=null==s.ty?A:s.ty,k=30,R=Math.max(k,e.width-u-k),E=Math.max(k,e.height-h-k);return{id:t,key:t,x:Math.floor(30+Math.random()*(R-30)),y:Math.floor(30+Math.random()*(E-30)),w:u,h:h,tx:T,ty:_,iw:n,ih:a,locked:!1}}),b("confirm"),x("INTERACTION_POSTER_ASSEMBLE")}();if("control_room_door"===t.type)return p.flags&&p.flags.controlRoomUnlocked?void O("control_room",300):void(p.inventory.some(e=>"keycard"===e.type)?(p.flags.controlRoomUnlocked=!0,x("TRY_CONTROL_ROOM_DOOR_WITH_KEYCARD"),setTimeout(()=>{O("control_room",300)},800)):x("TRY_CONTROL_ROOM_DOOR"));if("control_desk"===t.type)return void function(e={}){if(p.controlPanelOpen)return;p.controlPanelOpen=!0,e.silent||(0===p.controlPanel.openedCount?x("INTERACTION_CONTROL_PANEL"):x("INTERACTION_CONTROL_PANEL_AGAIN"),p.controlPanel.openedCount++);let t=["yellow","blue","green","sys"].findIndex(e=>"sys"!==e&&!function(e){return"yellow"===e?!!p.controlPanel.yellowOn:"blue"===e?!!p.controlPanel.blueOn:"green"===e&&!!p.controlPanel.greenOn}(e));p.controlPanel.selectedIndex=t>=0?t:0}();if(p.inventory.length<5){p.objects.splice(i,1),p.inventory.push(t),m.isInteracting=!0,m.interactionTimer=30,m.velocityX=0,b("pickup");let e=p.inventory.some(e=>"newspaper"===e.type),o=p.inventory.some(e=>"wallet"===e.type);e&&o&&setTimeout(()=>x("HAS_NEWSPAPER_AND_WALLET"),1e3)}}}()}}}),document.addEventListener("keyup",e=>{p.keys[e.code]=!1}),window.addEventListener("blur",()=>{p.keys={}}),async function(){try{let e=new URL("credits.json",window.location.href),t=await fetch(e.toString(),{cache:"no-cache"});if(!t.ok)throw new Error(`HTTP ${t.status}`);let o=await t.json();p.credits.data=o,p.credits.loaded=!0,p.credits.error=null}catch(e){p.credits.loaded=!1,p.credits.error=String(e&&e.message?e.message:e),p.credits.data={title:"TERMINAL",subtitle:"Thank you for playing",sections:[]}}}(),function e(){P(),L(),requestAnimationFrame(e)}()})();